<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuronQ - 最強学習アプリ</title>
    <meta name="description" content="フラッシュカード、クイズ、間隔反復を組み合わせた最強の学習アプリ">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <meta name="theme-color" content="#6366f1">
</head>

<body>
    <!-- Top Header (Desktop) -->
    <header id="top-header">
        <div class="header-left">
            <div class="logo">
                <i data-lucide="brain-circuit"></i>
                <span>NeuronQ</span>
            </div>
        </div>
        <div class="header-center" id="desktop-nav">
            <button class="tab-btn active" data-mode="study" onclick="app.setMode('study')">
                <i data-lucide="book-open"></i><span>学習</span>
            </button>
            <button class="tab-btn" data-mode="quiz" onclick="app.setMode('quiz')">
                <i data-lucide="list-checks"></i><span>テスト</span>
            </button>
            <button class="tab-btn" data-mode="edit" onclick="app.setMode('edit')">
                <i data-lucide="file-edit"></i><span>編集</span>
            </button>
            <button class="tab-btn" data-mode="stats" onclick="app.setMode('stats')">
                <i data-lucide="bar-chart-3"></i><span>分析</span>
            </button>
        </div>
        <div class="header-right">
            <div class="streak-badge" id="streak-badge" title="連続学習日数">
                <i data-lucide="flame"></i>
                <span id="streak-count">0</span>
            </div>
            <button class="icon-btn" onclick="app.toggleTheme()" title="テーマ切替">
                <i data-lucide="moon" id="theme-icon"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content">

        <!-- ==================== STUDY VIEW ==================== -->
        <section id="study-view" class="view active-view">
            <div class="study-toolbar">
                <select id="study-folder-select" class="select-modern"
                    onchange="app.handleStudyFolderChange(this.value)">
                    <option value="All">すべてのフォルダ</option>
                </select>
                <div class="toolbar-actions">
                    <button class="chip-btn" onclick="app.toggleShuffle()" id="btn-shuffle" title="シャッフル">
                        <i data-lucide="shuffle"></i>
                    </button>
                    <button class="chip-btn" onclick="app.filterDueCards()" id="btn-due" title="復習カードのみ">
                        <i data-lucide="clock"></i>
                    </button>
                </div>
            </div>

            <div class="progress-bar-container">
                <div class="progress-bar" id="study-progress"></div>
            </div>
            <div class="progress-text">
                <span id="study-current">1</span> / <span id="study-total">0</span>
                <span class="mastery-indicator" id="mastery-indicator"></span>
            </div>

            <div class="flashcard-wrapper" id="flashcard-wrapper">
                <div class="flashcard" id="flashcard" onclick="app.flipCard()">
                    <div class="card-face card-front">
                        <div class="card-badge">Question</div>
                        <div class="card-body" id="card-question">問題を追加してください</div>
                        <img id="card-image" class="card-img hidden" alt="">
                        <button class="tts-btn" onclick="event.stopPropagation(); app.speak('question')" title="読み上げ">
                            <i data-lucide="volume-2"></i>
                        </button>
                    </div>
                    <div class="card-face card-back">
                        <div class="card-badge">Answer</div>
                        <div class="card-body" id="card-answer">答えが表示されます</div>
                        <div class="card-explanation hidden" id="card-explanation"></div>
                    </div>
                </div>
            </div>

            <div class="study-actions">
                <button class="action-btn wrong" onclick="app.rateCard(1)">
                    <i data-lucide="x"></i>
                    <span>忘れた</span>
                </button>
                <button class="action-btn auto" onclick="app.toggleAutoPlay()" id="btn-auto">
                    <i data-lucide="play"></i>
                    <span>自動</span>
                </button>
                <button class="action-btn flip" onclick="app.flipCard()">
                    <i data-lucide="rotate-cw"></i>
                    <span>めくる</span>
                </button>
                <button class="action-btn correct" onclick="app.rateCard(4)">
                    <i data-lucide="check"></i>
                    <span>完璧</span>
                </button>
            </div>
        </section>

        <!-- ==================== QUIZ VIEW ==================== -->
        <section id="quiz-view" class="view">
            <!-- Quiz Setup -->
            <div id="quiz-setup" class="quiz-setup-card">
                <div class="quiz-setup-icon">
                    <i data-lucide="trophy"></i>
                </div>
                <h2>実力テスト</h2>
                <p class="subtitle">ランダムに出題して実力をチェック！</p>

                <div id="quiz-resume-banner" class="resume-banner hidden">
                    <p>中断中のテストがあります</p>
                    <div class="resume-actions">
                        <button class="btn-sm primary" onclick="app.resumeQuiz()">再開</button>
                        <button class="btn-sm" onclick="app.discardQuiz()">破棄</button>
                    </div>
                </div>

                <div class="quiz-options">
                    <div class="option-group">
                        <label>出題形式</label>
                        <div class="toggle-group">
                            <button class="toggle-btn active" data-type="4choice"
                                onclick="app.setQuizType(this)">4択</button>
                            <button class="toggle-btn" data-type="input" onclick="app.setQuizType(this)">記述式</button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label>出題数</label>
                        <div class="toggle-group">
                            <button class="toggle-btn" data-count="5" onclick="app.setQuizCount(this)">5問</button>
                            <button class="toggle-btn active" data-count="10"
                                onclick="app.setQuizCount(this)">10問</button>
                            <button class="toggle-btn" data-count="20" onclick="app.setQuizCount(this)">20問</button>
                            <button class="toggle-btn" data-count="all" onclick="app.setQuizCount(this)">全問</button>
                        </div>
                    </div>
                    <div class="option-group">
                        <label>フォルダ</label>
                        <select id="quiz-folder-select" class="select-modern">
                            <option value="All">すべて</option>
                        </select>
                    </div>
                </div>
                <button class="btn-primary btn-lg" onclick="app.startQuiz()">
                    <i data-lucide="play"></i> テスト開始
                </button>
            </div>

            <!-- Quiz In-Progress -->
            <div id="quiz-active" class="hidden">
                <div class="quiz-header">
                    <div class="quiz-progress-info">
                        <span class="quiz-num"><span id="quiz-index">1</span>/<span id="quiz-total">10</span></span>
                        <div class="quiz-timer" id="quiz-timer">00:00</div>
                    </div>
                    <div class="quiz-progress-bar">
                        <div class="quiz-progress-fill" id="quiz-progress-fill"></div>
                    </div>
                    <div class="quiz-score-display">
                        Score: <span id="quiz-score">0</span>
                    </div>
                </div>

                <div class="quiz-question-card">
                    <div class="quiz-q-text" id="quiz-question"></div>
                    <img id="quiz-image" class="card-img hidden" alt="">
                </div>

                <!-- 4-Choice Options -->
                <div id="quiz-choices" class="quiz-choices"></div>

                <!-- Typing Input -->
                <div id="quiz-typing" class="quiz-typing hidden">
                    <input type="text" id="quiz-input" class="input-modern" placeholder="答えを入力..." autocomplete="off">
                    <button class="btn-primary" onclick="app.submitTypingAnswer()">回答</button>
                </div>

                <!-- Explanation after answer -->
                <div id="quiz-feedback" class="quiz-feedback hidden">
                    <div id="quiz-feedback-icon"></div>
                    <div id="quiz-feedback-text"></div>
                    <div id="quiz-explanation-text" class="explanation-text"></div>
                    <button class="btn-primary" onclick="app.nextQuizQuestion()">次へ →</button>
                </div>
            </div>

            <!-- Quiz Result -->
            <div id="quiz-result" class="hidden">
                <div class="result-card">
                    <div class="result-icon" id="result-icon"></div>
                    <h2 id="result-title">結果発表</h2>
                    <div class="result-score" id="result-score-display"></div>
                    <p id="result-message"></p>
                    <div id="result-wrong-list"></div>
                    <div class="result-actions">
                        <button class="btn-primary" onclick="app.startQuiz()">もう一度</button>
                        <button class="btn-outline hidden" id="btn-review-wrong"
                            onclick="app.startReviewQuiz()">間違いを復習</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==================== EDIT VIEW ==================== -->
        <section id="edit-view" class="view">
            <div class="edit-header">
                <h2>カード管理 <span class="count-badge" id="edit-count">0</span></h2>
                <div class="edit-actions">
                    <button class="btn-sm" onclick="app.exportJSON()"><i data-lucide="download"></i> バックアップ</button>
                    <button class="btn-sm" onclick="document.getElementById('json-input').click()"><i
                            data-lucide="upload"></i> 復元</button>
                    <input type="file" id="json-input" accept=".json" class="hidden" onchange="app.importJSON(this)">
                    <button class="btn-sm" onclick="app.exportCSV()"><i data-lucide="file-spreadsheet"></i> CSV</button>
                    <input type="file" id="csv-input" accept=".csv" class="hidden" onchange="app.importCSV(this)">
                </div>
            </div>

            <button class="btn-primary btn-add" onclick="app.openModal('add')">
                <i data-lucide="plus"></i> 新しいカードを追加
            </button>

            <!-- Folder Toolbar -->
            <div class="folder-toolbar-row">
                <select id="edit-folder-select" class="select-modern" onchange="app.handleEditFolderChange(this.value)">
                    <option value="All">すべてのフォルダ</option>
                </select>
                <div class="folder-actions-group">
                    <button class="icon-btn-sm" onclick="app.createFolder()" title="新規フォルダ"><i
                            data-lucide="folder-plus"></i></button>
                    <button class="icon-btn-sm" onclick="app.renameFolder()" title="名前変更"><i
                            data-lucide="pencil"></i></button>
                    <button class="icon-btn-sm" onclick="app.toggleFolderLock()" title="ロック切替" id="btn-lock"><i
                            data-lucide="unlock"></i></button>
                    <button class="icon-btn-sm danger" onclick="app.deleteFolder()" title="削除"><i
                            data-lucide="trash-2"></i></button>
                </div>
            </div>

            <div class="search-row">
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" id="search-input" placeholder="検索..." oninput="app.renderEditList()">
                </div>
            </div>

            <!-- Bulk Action Bar -->
            <div id="bulk-bar" class="bulk-bar hidden">
                <span><strong id="bulk-count">0</strong>件選択中</span>
                <div class="bulk-actions">
                    <select id="bulk-folder-target" class="select-sm"></select>
                    <button class="btn-sm primary" onclick="app.moveSelected()">移動</button>
                    <button class="btn-sm danger" onclick="app.deleteSelected()">削除</button>
                </div>
            </div>

            <div id="card-list" class="card-list-grid"></div>
        </section>

        <!-- ==================== STATS VIEW ==================== -->
        <section id="stats-view" class="view">
            <h2 class="section-title">学習データ分析</h2>

            <div class="stats-grid">
                <div class="stat-card accent-blue">
                    <div class="stat-icon"><i data-lucide="layers"></i></div>
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">総カード数</div>
                </div>
                <div class="stat-card accent-green">
                    <div class="stat-icon"><i data-lucide="check-circle"></i></div>
                    <div class="stat-value" id="stat-mastered">0</div>
                    <div class="stat-label">習得済み</div>
                </div>
                <div class="stat-card accent-amber">
                    <div class="stat-icon"><i data-lucide="clock"></i></div>
                    <div class="stat-value" id="stat-due">0</div>
                    <div class="stat-label">要復習</div>
                </div>
                <div class="stat-card accent-purple">
                    <div class="stat-icon"><i data-lucide="flame"></i></div>
                    <div class="stat-value" id="stat-streak">0</div>
                    <div class="stat-label">連続日数</div>
                </div>
            </div>

            <div class="chart-card">
                <h3>習得率</h3>
                <div class="donut-container" id="donut-chart"></div>
                <div class="donut-legend" id="donut-legend"></div>
            </div>

            <div class="chart-card">
                <h3>学習記録（過去90日）</h3>
                <div class="heatmap-scroll">
                    <div class="heatmap" id="heatmap"></div>
                </div>
            </div>

            <div class="chart-card">
                <h3>フォルダ別カード数</h3>
                <div id="folder-chart" class="folder-bars"></div>
            </div>
        </section>
    </main>

    <!-- Add/Edit Card Modal -->
    <div id="card-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modal-title">カードを追加</h3>
                <button class="icon-btn" onclick="app.closeModal()"><i data-lucide="x"></i></button>
            </div>
            <form id="card-form" onsubmit="app.handleFormSubmit(event)">
                <div class="field">
                    <label>問題文 <span class="required">*</span></label>
                    <textarea id="input-question" required placeholder="問題を入力..." rows="3"></textarea>
                </div>
                <div class="field">
                    <label>答え <span class="required">*</span></label>
                    <textarea id="input-answer" required placeholder="答えを入力..." rows="3"></textarea>
                </div>
                <div class="field">
                    <label>解説（任意）</label>
                    <textarea id="input-explanation" placeholder="補足説明..." rows="2"></textarea>
                </div>
                <div class="field-row">
                    <div class="field">
                        <label>フォルダ</label>
                        <input type="text" id="input-folder" list="folder-datalist" placeholder="メイン">
                        <datalist id="folder-datalist"></datalist>
                    </div>
                    <div class="field">
                        <label>タグ</label>
                        <input type="text" id="input-tags" placeholder="例: 電気, 法規">
                    </div>
                </div>
                <div class="field">
                    <label>画像（任意）</label>
                    <input type="file" id="input-image" accept="image/*">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-outline" onclick="app.closeModal()">キャンセル</button>
                    <button type="submit" class="btn-primary" id="btn-submit">追加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas"></canvas>

    <!-- Bottom Navigation (Mobile) -->
    <nav id="bottom-nav">
        <button class="bnav-btn active" data-mode="study" onclick="app.setMode('study')">
            <i data-lucide="book-open"></i>
            <span>学習</span>
        </button>
        <button class="bnav-btn" data-mode="quiz" onclick="app.setMode('quiz')">
            <i data-lucide="list-checks"></i>
            <span>テスト</span>
        </button>
        <button class="bnav-btn" data-mode="edit" onclick="app.setMode('edit')">
            <i data-lucide="file-edit"></i>
            <span>編集</span>
        </button>
        <button class="bnav-btn" data-mode="stats" onclick="app.setMode('stats')">
            <i data-lucide="bar-chart-3"></i>
            <span>分析</span>
        </button>
    </nav>

    <script src="data.js"></script>
    <script src="app_core.js"></script>
    <script src="app_features.js"></script>
    <script>lucide.createIcons();</script>
</body>

</html>